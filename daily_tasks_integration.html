<!-- Add this section before the closing </body> tag in your dashboard.php -->

<!-- View/Edit/Delete Daily Tasks Modal -->
<div class="modal fade" id="manageDailyTasksModal" tabindex="-1" aria-labelledby="manageDailyTasksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageDailyTasksModalLabel">Manage Daily Tasks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="dailyTasksManagement">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="task_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editTaskTitle" class="form-label">Task Title *</label>
                        <input type="text" class="form-control" id="editTaskTitle" name="task_title" required maxlength="255">
                    </div>
                    <div class="mb-3">
                        <label for="editTaskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editTaskDescription" name="task_description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editAssignedToName" class="form-label">Assigned To</label>
                        <input type="text" class="form-control" id="editAssignedToName" name="assigned_to_name" placeholder="Enter assignee name">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="editTaskStatus" class="form-label">Status</label>
                            <select class="form-select" id="editTaskStatus" name="task_status">
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editTaskPriority" class="form-label">Priority</label>
                            <select class="form-select" id="editTaskPriority" name="priority">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Function to load and display daily tasks for management
    function loadDailyTasks() {
        // Show the modal first
        const modal = new bootstrap.Modal(document.getElementById('manageDailyTasksModal'));
        modal.show();
        
        // Load tasks via AJAX
        fetch('ajax/get_daily_tasks.php')
            .then(response => response.json())
            .then(data => {
                const tasksContainer = document.getElementById('dailyTasksManagement');
                
                if (data.success && data.tasks.length > 0) {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Task Title</th>
                                        <th>Description</th>
                                        <th>Assigned To</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    data.tasks.forEach(task => {
                        const priorityClass = {
                            'urgent': 'bg-danger',
                            'high': 'bg-warning text-dark',
                            'medium': 'bg-info text-dark',
                            'low': 'bg-secondary'
                        }[task.priority] || 'bg-secondary';
                        
                        const statusClass = {
                            'pending': 'bg-secondary',
                            'in_progress': 'bg-warning text-dark',
                            'completed': 'bg-success',
                            'cancelled': 'bg-danger'
                        }[task.task_status] || 'bg-secondary';
                        
                        html += `
                            <tr>
                                <td><strong>${task.task_title}</strong></td>
                                <td>${task.task_description ? task.task_description.substring(0, 50) + (task.task_description.length > 50 ? '...' : '') : 'No description'}</td>
                                <td>${task.assigned_to_name || 'Not assigned'}</td>
                                <td><span class="badge ${priorityClass}">${task.priority}</span></td>
                                <td><span class="badge ${statusClass}">${task.task_status}</span></td>
                                <td>${new Date(task.created_at).toLocaleTimeString()}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-primary" onclick="editTask(${task.id}, '${task.task_title}', '${task.task_description || ''}', '${task.assigned_to_name || ''}', '${task.task_status}', '${task.priority}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="deleteTask(${task.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>`;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>`;
                    
                    tasksContainer.innerHTML = html;
                } else {
                    tasksContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No tasks for today</h5>
                            <p class="text-muted">Click "Add Daily Task" to create your first task.</p>
                        </div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('dailyTasksManagement').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading tasks: ${error.message}
                    </div>`;
            });
    }

    // Function to open edit task modal
    function editTask(taskId, title, description, assignedTo, status, priority) {
        // Set form values
        document.getElementById('editTaskId').value = taskId;
        document.getElementById('editTaskTitle').value = title;
        document.getElementById('editTaskDescription').value = description;
        document.getElementById('editAssignedToName').value = assignedTo;
        document.getElementById('editTaskStatus').value = status;
        document.getElementById('editTaskPriority').value = priority;
        
        // Hide the management modal and show edit modal
        const manageModal = bootstrap.Modal.getInstance(document.getElementById('manageDailyTasksModal'));
        manageModal.hide();
        
        const editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
        editModal.show();
    }

    // Handle edit task form submission
    document.getElementById('editTaskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('ajax/edit_daily_task.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Task updated successfully!');
                // Close edit modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
                editModal.hide();
                // Reload the management view
                loadDailyTasks();
            } else {
                alert('Error: ' + (data.message || 'Failed to update task'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the task.');
        });
    });

    // Function to delete a task
    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            const formData = new FormData();
            formData.append('task_id', taskId);
            
            fetch('ajax/delete_daily_task.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Task deleted successfully!');
                    // Reload the task list
                    loadDailyTasks();
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete task'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the task.');
            });
        }
    }
</script>