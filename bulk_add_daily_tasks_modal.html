<!-- Bulk Add Daily Tasks Modal -->
<div class="modal fade" id="bulkAddDailyTaskModal" tabindex="-1" aria-labelledby="bulkAddDailyTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkAddDailyTaskModalLabel">
                    <i class="fas fa-tasks me-2"></i>Bulk Add Daily Tasks
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkAddTaskForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="bulkAssignedTo" class="form-label">Assign To <span class="text-danger">*</span></label>
                            <select class="form-select" id="bulkAssignedTo" name="assigned_to" required>
                                <option value="">Select User</option>
                                <?php
                                // Get all users for assignment dropdown
                                try {
                                    $userStmt = $pdo->query("
                                        SELECT u.id, u.email, sp.full_name 
                                        FROM users u 
                                        LEFT JOIN staff_profiles sp ON u.id = sp.user_id 
                                        WHERE u.is_active = true 
                                        ORDER BY sp.full_name ASC, u.email ASC
                                    ");
                                    $users = $userStmt->fetchAll(PDO::FETCH_ASSOC);
                                    
                                    foreach ($users as $user) {
                                        $display_name = !empty($user['full_name']) ? $user['full_name'] : $user['email'];
                                        echo "<option value='{$user['id']}'>{$display_name}</option>";
                                    }
                                } catch (Exception $e) {
                                    // Fallback if staff_profiles table doesn't exist
                                    $userStmt = $pdo->query("SELECT id, email FROM users WHERE is_active = true ORDER BY email ASC");
                                    $users = $userStmt->fetchAll(PDO::FETCH_ASSOC);
                                    foreach ($users as $user) {
                                        echo "<option value='{$user['id']}'>{$user['email']}</option>";
                                    }
                                }
                                ?>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="bulkTaskPriority" class="form-label">Default Priority</label>
                            <select class="form-select" id="bulkTaskPriority" name="default_priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tasks <span class="text-danger">*</span></label>
                        <div id="taskListContainer">
                            <!-- Task items will be added here dynamically -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addTaskButton">
                            <i class="fas fa-plus me-1"></i>Add Another Task
                        </button>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="bulkSubmitButton">
                            <i class="fas fa-save me-1"></i>Create All Tasks
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Bulk task management functions
let taskCounter = 1;

// Initialize the first task field
document.addEventListener('DOMContentLoaded', function() {
    addTaskField();
    
    // Add task button event
    document.getElementById('addTaskButton').addEventListener('click', addTaskField);
    
    // Form submission
    document.getElementById('bulkAddTaskForm').addEventListener('submit', handleBulkTaskSubmission);
});

// Add a new task field
function addTaskField() {
    const container = document.getElementById('taskListContainer');
    const taskDiv = document.createElement('div');
    taskDiv.className = 'task-item mb-3 p-3 border rounded';
    taskDiv.dataset.taskId = taskCounter;
    
    taskDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Task #${taskCounter}</h6>
            <button type="button" class="btn btn-outline-danger btn-sm remove-task" onclick="removeTaskField(${taskCounter})">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <input type="text" class="form-control task-title" name="tasks[${taskCounter}][task_title]" 
                       placeholder="Task Title *" required>
            </div>
            <div class="col-md-3 mb-2">
                <select class="form-select task-priority" name="tasks[${taskCounter}][priority]">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <button type="button" class="btn btn-outline-secondary btn-sm w-100 copy-down" 
                        onclick="copyDown(${taskCounter})" title="Copy this priority to all tasks below">
                    <i class="fas fa-arrow-down"></i> Copy Down
                </button>
            </div>
        </div>
        <div class="mb-2">
            <textarea class="form-control task-description" name="tasks[${taskCounter}][task_description]" 
                      rows="2" placeholder="Description (optional)"></textarea>
        </div>
    `;
    
    container.appendChild(taskDiv);
    taskCounter++;
    
    // Update remove buttons visibility
    updateRemoveButtons();
}

// Remove a task field
function removeTaskField(taskId) {
    const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
    if (taskElement) {
        taskElement.remove();
        updateTaskNumbers();
        updateRemoveButtons();
    }
}

// Update task numbering after removal
function updateTaskNumbers() {
    const tasks = document.querySelectorAll('.task-item');
    tasks.forEach((task, index) => {
        const title = task.querySelector('h6');
        const taskId = index + 1;
        title.textContent = `Task #${taskId}`;
        task.dataset.taskId = taskId;
        
        // Update input names
        const inputs = task.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            const name = input.name;
            const newName = name.replace(/\[(\d+)\]/, `[${taskId}]`);
            input.name = newName;
        });
    });
    
    taskCounter = tasks.length + 1;
}

// Update remove buttons visibility
function updateRemoveButtons() {
    const tasks = document.querySelectorAll('.task-item');
    const removeButtons = document.querySelectorAll('.remove-task');
    
    // Hide remove button for the first task
    if (tasks.length <= 1) {
        removeButtons.forEach(btn => btn.style.display = 'none');
    } else {
        removeButtons.forEach(btn => btn.style.display = 'block');
    }
}

// Copy priority down to all tasks below
function copyDown(currentTaskId) {
    const currentTask = document.querySelector(`[data-task-id="${currentTaskId}"]`);
    const currentPriority = currentTask.querySelector('.task-priority').value;
    
    const allTasks = Array.from(document.querySelectorAll('.task-item'));
    const currentIndex = allTasks.findIndex(task => parseInt(task.dataset.taskId) === currentTaskId);
    
    // Apply to all tasks below
    for (let i = currentIndex + 1; i < allTasks.length; i++) {
        allTasks[i].querySelector('.task-priority').value = currentPriority;
    }
    
    showToast('Priority copied to tasks below', 'success');
}

// Handle bulk task submission
function handleBulkTaskSubmission(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const submitButton = document.getElementById('bulkSubmitButton');
    
    // Disable submit button and show loading
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating Tasks...';
    
    // Convert form data to JSON
    const tasks = [];
    const assignedTo = formData.get('assigned_to');
    const defaultPriority = formData.get('default_priority');
    
    // Collect all tasks
    const taskItems = document.querySelectorAll('.task-item');
    taskItems.forEach(item => {
        const title = item.querySelector('.task-title').value.trim();
        const description = item.querySelector('.task-description').value.trim();
        const priority = item.querySelector('.task-priority').value;
        
        if (title) {
            tasks.push({
                task_title: title,
                task_description: description,
                priority: priority,
                assigned_to: assignedTo
            });
        }
    });
    
    if (tasks.length === 0) {
        showToast('Please add at least one task with a title', 'error');
        resetSubmitButton();
        return;
    }
    
    // Send AJAX request
    fetch('ajax/create_multiple_daily_tasks.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tasks: tasks })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // Show detailed results
            if (data.created_tasks.length > 0) {
                console.log('Created tasks:', data.created_tasks);
            }
            if (data.failed_tasks.length > 0) {
                console.log('Failed tasks:', data.failed_tasks);
                showToast(`${data.failed_tasks.length} task(s) failed to create`, 'warning');
            }
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddDailyTaskModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('bulkAddTaskForm').reset();
            document.getElementById('taskListContainer').innerHTML = '';
            taskCounter = 1;
            addTaskField(); // Add initial task field
            
            // Refresh task list if visible
            if (typeof loadDailyTasks === 'function') {
                setTimeout(loadDailyTasks, 500);
            }
        } else {
            showToast(data.message || 'Failed to create tasks', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while creating tasks', 'error');
    })
    .finally(() => {
        resetSubmitButton();
    });
}

// Reset submit button
function resetSubmitButton() {
    const submitButton = document.getElementById('bulkSubmitButton');
    submitButton.disabled = false;
    submitButton.innerHTML = '<i class="fas fa-save me-1"></i>Create All Tasks';
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to toast container
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    // Initialize and show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}
</script>